# load stock price data(CSV file, 7 column)
# stock, date, open, high, low, close, vol
import numpy as np
c, v = np.loadtxt('data.csv', delimiter=',', usecols=(6,7), unpack=True)  # 取第6,7個column

print(c)  # 30筆data
print(v)


# 計算VWAP(value weighted average price)，用vol當作權重計算價格加權平均數
vwap = np.average(c, weights = v)
print("VWAP = ", vwap)


print(np.max(c))  # maximum
print(np.min(c))  # minimum
print(np.median(c))  # median

sorted_close = np.msort(c)  # 排序
print(sorted_close)

print(np.var(c))  # variance

# 計算股票報酬率
# session (1) 傳統報酬率
import numpy as np
c = np.loadtxt('data.csv', delimiter=',', usecols=(6,), unpack=True) # len(c)=30(筆), 0...29
returns = np.diff(c) / c[:-1] # c[:-1] : 0~28不含最後一筆, diff(c)一階差分 : 0~28
print(c)
print(np.diff(c))  # 29筆data
print(c[:-1])      # 29筆data
print("Standard deviation =", np.std(returns))  # std

# session (2) 對數報酬率
logreturns = np.diff(np.log(c))
posretindices = np.where(returns>0) # Tuple 取得正報酬
print(logreturns)
print(posretindices)
print("Indices with positive returns", posretindices)

# 計算股票波動度(標準差)
daily_vol = np.std(logreturns)
annual_vol = daily_vol * np.sqrt(252.)  # 年化標準差
monthly_vol = annual_vol * np.sqrt(1./12.)
print("Daily volatility", daily_vol)
print("Monthly volatility", monthly_vol)
print("Annual volatility", annual_vol)


# WeekAnalysis 星期分析(星期效應)
import numpy as np
from datetime import datetime

def datestr2num(ndary):    # 定義函數 日期格式轉星期
    lstdates = list(ndary)
    strdates = list()
    weekdates = list()
    num = len(lstdates)
    for i in range(num):
        strdates.append(str(lstdates[i]))
        weekdates.append(datetime.strptime(strdates[i], "%d-%m-%Y").date().weekday())  # 原日期格式 "%d-%m-%Y"            
    return weekdates


def pricestr2flt(ndary):    # price data轉float (原本是str)  
    lstprice = list(ndary)
    fltprice = list()
    strprice = list()
    num = len(lstprice)
    for i in range(num):
        strprice.append(str(lstprice[i]))
        fltprice.append(float(strprice[i]))
    return fltprice

# Monday 0, Tuesday 1, Wednesday 2, Thursday 3, Friday 4, Saturday 5, Sunday 6
nddates, ndclose = np.loadtxt('data.csv', dtype='str', delimiter=',', usecols=(1, 6), unpack=True)
print(nddates)
print(ndclose)

# 原本日期與價格都是str，現在執行先前定義的函式轉成我們要的格式
fltclose = list()
fltclose = pricestr2flt(ndclose)  # pricestr2flt 函式
print(fltclose)

weekdates = list()
weekdates = datestr2num(nddates)  # datestr2num 函式
print(weekdates)

# 列出每個(週一)的所有價格(週二、週三...週五)並計算平均數
averages = np.zeros(5)
ndweekdates = np.array(weekdates)
ndclose = np.array(fltclose)
for i in range(5):
    indices = np.where(ndweekdates == i)
    prices = np.take(ndclose, indices)
    avg = np.mean(prices)
    print("Day", i, "prices", prices, "Average", avg)
    averages[i] = avg

# 找出星期幾的平均價格最高    
top = np.max(averages)
print("Highest average", top)
print("Top day of the week", np.argmax(averages))

# 找出星期幾的平均價格最低
bottom = np.min(averages)
print("Lowest average", bottom)
print("Bottom day of the week", np.argmin(averages))

